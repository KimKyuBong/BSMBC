# 🚀 방송 제어 시스템 - 자동 시작 설정 가이드

## 📋 목차
1. [문제 상황](#문제-상황)
2. [해결 방법](#해결-방법)
3. [파일 설명](#파일-설명)
4. [FAQ](#faq)

---

## 🔍 문제 상황

### 증상
- Windows 재부팅 후 방송 제어 서버가 자동으로 시작되지 않음
- 수동으로 start_server.bat을 실행하면 정상 작동

### 원인
1. **Windows 서비스 설정 문제**
   - 시작 유형이 "수동"으로 설정됨
   - 자동 시작되지 않음

2. **작업 스케줄러 실행 문제**
   - VBS 스크립트가 실행되지만 서버가 유지되지 않음
   - 로그온 모드 및 권한 문제

---

## ✅ 해결 방법

두 가지 방법 중 **하나만** 선택하여 사용하세요.

### 방법 1: Windows 서비스 사용 (권장) ⭐

**장점:**
- ✅ 가장 안정적
- ✅ Windows가 자동 관리
- ✅ 실패 시 자동 재시작
- ✅ 로그인 없이 실행 가능

**설정 방법:**

```batch
# 1. 관리자 권한으로 PowerShell 열기

# 2. 프로젝트 디렉토리로 이동
cd C:\Users\bssmBroadcast\BSMBC

# 3. 작업 스케줄러 제거 (충돌 방지)
schtasks /delete /tn "BroadcastSystem" /f

# 4. 서비스 복구 스크립트 실행
# service_fix.bat을 마우스 오른쪽 클릭 -> "관리자 권한으로 실행"
```

**서비스 관리:**
- 시작: `service_start.bat` (관리자 권한)
- 중지: `service_stop.bat` (관리자 권한)
- 상태 확인: `service_status.bat`
- 재시작: `service_restart.bat` (관리자 권한)

---

### 방법 2: 작업 스케줄러 사용 (대안)

**장점:**
- ✅ 설정이 간단
- ✅ GUI로 관리 가능

**단점:**
- ⚠️ 복구 기능 제한적
- ⚠️ 로그 관리 어려움

**설정 방법:**

```batch
# 1. 관리자 권한으로 PowerShell 열기

# 2. 프로젝트 디렉토리로 이동
cd C:\Users\bssmBroadcast\BSMBC

# 3. 서비스 제거 (충돌 방지)
service_uninstall.bat

# 4. 작업 스케줄러 재설정
# fix_startup_task.bat을 마우스 오른쪽 클릭 -> "관리자 권한으로 실행"
```

**작업 관리:**
- 수동 실행: `schtasks /run /tn "BroadcastSystem"`
- 상태 확인: `taskschd.msc` (작업 스케줄러 GUI)

---

## 🧪 테스트 방법

### 1. 즉시 테스트

```batch
# 서버가 실행 중인지 확인
curl http://localhost:8000/health

# 예상 응답: {"status":"healthy"}
```

### 2. 포트 확인

```batch
netstat -ano | findstr :8000

# 예상 결과: 8000 포트가 LISTENING 상태
```

### 3. 재부팅 테스트

```batch
# 1. PC 재부팅
shutdown /r /t 0

# 2. 재부팅 후 위의 테스트 1, 2 반복
```

---

## 📁 파일 설명

### 서비스 관련 파일

| 파일명 | 설명 | 관리자 권한 |
|--------|------|------------|
| `service_install.bat` | 서비스 설치 | ✅ 필요 |
| `service_uninstall.bat` | 서비스 제거 | ✅ 필요 |
| `service_start.bat` | 서비스 시작 | ✅ 필요 |
| `service_stop.bat` | 서비스 중지 | ✅ 필요 |
| `service_restart.bat` | 서비스 재시작 | ✅ 필요 |
| `service_status.bat` | 서비스 상태 확인 | ❌ 불필요 |
| `service_fix.bat` | 서비스 복구 (새로 추가) | ✅ 필요 |
| `windows_service.py` | 서비스 구현 코드 | - |

### 작업 스케줄러 관련 파일

| 파일명 | 설명 | 관리자 권한 |
|--------|------|------------|
| `create_startup_task.bat` | 작업 등록 (기본) | ✅ 필요 |
| `remove_startup_task.bat` | 작업 제거 | ✅ 필요 |
| `fix_startup_task.bat` | 작업 재설정 (새로 추가) | ✅ 필요 |
| `start_server_hidden.vbs` | 백그라운드 실행 스크립트 | - |

### 유틸리티 파일

| 파일명 | 설명 | 관리자 권한 |
|--------|------|------------|
| `check_service_logs.bat` | 로그 확인 (새로 추가) | ❌ 불필요 |
| `start_server.bat` | 수동 서버 시작 | ❌ 불필요 |
| `stop_server.bat` | 수동 서버 중지 | ❌ 불필요 |

### 문서 파일

| 파일명 | 설명 |
|--------|------|
| `TROUBLESHOOTING_GUIDE.md` | 상세 문제 해결 가이드 (영문) |
| `진단_결과_및_해결방안.md` | 진단 결과 및 기술 문서 |
| `서비스_문제_해결_가이드.txt` | 간단 가이드 (한글) |
| `README_서비스설정.md` | 이 문서 |

---

## 🔧 개선 사항 (2025-10-16)

### ✅ 수정된 내용

1. **windows_service.py**
   - 서비스 시작 시 5초 지연 (네트워크 초기화 대기)
   - 작업 디렉토리 명시적 설정
   - 필요한 디렉토리 자동 생성
   - 서비스 재설치 시 기존 서비스 자동 제거
   - 이벤트 로그 개선

2. **service_install.bat**
   - 설치 후 자동으로 시작 유형을 "자동(지연)"으로 설정
   - 네트워크 초기화 대기 설정

3. **start_server_hidden.vbs**
   - `uvicorn` 직접 실행 → `production_server.py` 사용
   - 더 안정적인 서버 시작

### ✨ 새로 추가된 파일

1. **service_fix.bat**
   - 서비스 설정 자동 복구
   - 시작 유형을 자동으로 변경
   - 복구 설정 (실패 시 자동 재시작)
   - 서비스 테스트 자동 실행

2. **fix_startup_task.bat**
   - 작업 스케줄러 재설정
   - SYSTEM 계정으로 실행
   - 30초 시작 지연
   - 자동 테스트 포함

3. **check_service_logs.bat**
   - 최신 로그 빠른 확인
   - 서비스 상태 표시
   - 포트 사용 확인

---

## ❓ FAQ

### Q1: 어떤 방법을 선택해야 하나요?

**A:** **Windows 서비스 방식을 권장합니다.** 
- 더 안정적이고 Windows가 자동으로 관리
- 실패 시 자동 재시작 기능 내장
- 이벤트 로그로 문제 추적 용이

### Q2: 두 방법을 동시에 사용해도 되나요?

**A:** **아니요, 반드시 하나만 사용하세요.**
- 두 방법이 충돌하여 서버가 제대로 시작되지 않을 수 있습니다
- 포트 8000을 두 번 열려고 시도하면 오류 발생

### Q3: 관리자 권한이 왜 필요한가요?

**A:** Windows 서비스와 작업 스케줄러는 시스템 수준 기능이므로 관리자 권한이 필요합니다.

### Q4: 서버가 시작되지 않으면 어떻게 하나요?

**A:** 다음 순서로 확인하세요:
1. `check_service_logs.bat` 실행하여 로그 확인
2. `service_status.bat` 또는 `taskschd.msc`로 상태 확인
3. `eventvwr.msc`로 Windows 이벤트 로그 확인
4. `TROUBLESHOOTING_GUIDE.md` 문서 참조

### Q5: 로그는 어디에 저장되나요?

**A:** 
- 애플리케이션 로그: `logs\app_YYYYMMDD.log`
- Windows 이벤트 로그: `eventvwr.msc` → 애플리케이션

### Q6: 서비스를 다시 설치해야 하나요?

**A:** 아니요, 먼저 `service_fix.bat`을 실행해보세요.
- 대부분의 문제는 복구 스크립트로 해결됩니다
- 문제가 계속되면 재설치 고려

### Q7: 재부팅 후 얼마나 기다려야 하나요?

**A:** 
- Windows 서비스: 부팅 후 약 5-10초
- 작업 스케줄러: 부팅 후 약 30-40초 (30초 지연 설정)

---

## 📞 추가 지원

문제가 계속되면 다음 파일들을 확인하세요:

1. **TROUBLESHOOTING_GUIDE.md** - 상세한 문제 해결 가이드
2. **진단_결과_및_해결방안.md** - 기술적인 진단 내용
3. **서비스_문제_해결_가이드.txt** - 빠른 참조용 간단 가이드

---

## ✅ 최종 체크리스트

서비스 설정 후 다음을 확인하세요:

- [ ] 관리자 권한으로 스크립트 실행
- [ ] 하나의 방법만 선택 (서비스 또는 스케줄러)
- [ ] 다른 방법은 제거
- [ ] 서버 접속 테스트 성공 (http://localhost:8000/health)
- [ ] 포트 8000이 LISTENING 상태
- [ ] 재부팅 후 자동 시작 확인
- [ ] 로그 파일 정상 생성

모두 완료되었다면 설정 성공! 🎉

---

**마지막 업데이트:** 2025-10-16  
**버전:** 1.0





