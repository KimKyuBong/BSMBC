# 📖 사용 방법 (최신)

> 라즈베리파이 + Docker 환경 기준

---

## 🎯 방송 시스템 사용법

### 1. 시스템 시작

#### Docker 사용 (권장)
```bash
cd /home/bmbc/project/BSMBC
sudo docker compose up -d
```

#### 직접 실행
```bash
cd /home/bmbc/project/BSMBC
python3 main.py
```

---

### 2. 웹 UI 접속

브라우저에서 `http://라즈베리파이IP:8000` 접속

---

## 📻 방송하기

### A. 텍스트 방송 (TTS)

#### 웹 UI
1. "방송" 메뉴 선택
2. "텍스트 방송" 탭
3. 방송할 텍스트 입력
4. 대상 교실 선택 (예: 101, 102, 201)
5. "프리뷰 생성" 버튼
6. 미리듣기 후 "승인" 버튼

#### Python 코드
```python
import requests

# 1. 프리뷰 생성
response = requests.post(
    'http://localhost:8000/api/broadcast/text',
    data={
        'text': '점심시간입니다',
        'target_rooms': '101,102,103,104',  # 1학년 전체
        'language': 'ko',
        'auto_off': 'true'
    }
)

preview_id = response.json()['preview_id']

# 2. 프리뷰 승인
requests.post(
    f'http://localhost:8000/api/broadcast/preview/approve/{preview_id}'
)
```

### B. 오디오 파일 방송

#### 웹 UI
1. "방송" 메뉴 선택
2. "오디오 방송" 탭
3. 오디오 파일 업로드 (MP3, WAV 등)
4. 대상 교실 선택
5. "프리뷰 생성" 버튼
6. 미리듣기 후 "승인" 버튼

#### curl 명령
```bash
curl -X POST "http://localhost:8000/api/broadcast/audio" \
  -F "audio_file=@/path/to/audio.mp3" \
  --data-urlencode "target_rooms=101,102,201" \
  --data-urlencode "auto_off=true"
```

---

## 🎛️ 장치 제어

### A. 개별 장치

#### CLI
```bash
# 1학년 1반 켜기
python3 app/utils/cli.py control "1-1" --on

# 모둠12 끄기
python3 app/utils/cli.py control "모둠12" --off
```

#### API
```python
import requests

requests.post(
    'http://localhost:8000/api/device/matrix/turn-on',
    json={'row': 0, 'col': 0}  # 1행 1열 = 1-1
)
```

### B. 그룹 제어

#### CLI
```bash
# 1학년 전체 켜기
python3 app/utils/cli.py group grade1 --on

# 2학년 전체 켜기
python3 app/utils/cli.py group grade2 --on

# 모든 교실 끄기
python3 app/utils/cli.py group all --off
```

#### 사용 가능한 그룹
- `grade1` - 1학년 전체 (1-1, 1-2, 1-3, 1-4)
- `grade2` - 2학년 전체 (2-1, 2-2, 2-3, 2-4)
- `grade3` - 3학년 전체 (3-1, 3-2, 3-3, 3-4)
- `all` - 전체 교실 (12개)

---

## 📅 예약 방송

### 스케줄 추가

#### CLI
```bash
# 매일 오전 8시 30분에 1학년 켜기
python3 app/utils/cli.py schedule --add \
  --time 08:30 \
  --days "Monday,Tuesday,Wednesday,Thursday,Friday" \
  --target 0 \
  --state 1
```

#### 웹 UI
1. "스케줄" 메뉴 선택
2. "스케줄 추가" 버튼
3. 시간, 요일, 대상, 동작 설정
4. "저장" 버튼

### 스케줄 관리

```bash
# 스케줄 목록 확인
python3 app/utils/cli.py schedule --list

# 스케줄 삭제 (번호 1번)
python3 app/utils/cli.py schedule --delete 1

# 스케줄러 시작
python3 app/utils/cli.py schedule --start

# 스케줄러 중지
python3 app/utils/cli.py schedule --stop
```

---

## 🔧 설정 변경

### 장치 배치 수정

`config/device_matrix.json` 파일 수정:

```json
[
  ["1-1", "1-2", "1-3", "1-4", "장치5", ...],
  ["3-1", "3-2", "3-3", "3-4", ...],
  ["교행연회", "교사연구", ..., "모둠12", ...],
  ["본관1층", "융합1층", ..., "강당", "방송실", ...]
]
```

**수정 후**: 서버 자동 재로드 (개발 모드) 또는 재시작

**그룹 자동 생성**:
- `1학년전체`, `2학년전체`, `3학년전체` 자동 감지
- `전체교실` (학년-반 형식 모두)
- `실제장치` (전체)

### 네트워크 설정

방송 서버 IP/Port 변경:

#### 환경 변수
```bash
TARGET_IP=192.168.0.100 TARGET_PORT=23000 python3 main.py
```

#### Docker
```bash
# docker-compose.yml 수정
environment:
  - TARGET_IP=192.168.0.100
  - TARGET_PORT=23000
```

---

## 🎨 고급 사용법

### 오디오 정규화 설정

`app/core/config.py`:

```python
DEFAULT_TARGET_DBFS = -12.0  # 목표 볼륨 (dBFS)
```

### 시작/끝 신호음 변경

`data/start.mp3`, `data/end.mp3` 파일 교체

### 보안 설정

`config/security_config.json`:

```json
{
  "totp_enabled": true,        # TOTP 2단계 인증
  "ip_check_enabled": true,    # IP 검사
  "allowed_ips": [
    "192.168.0.0/16",
    "127.0.0.1/32"
  ]
}
```

---

## 📊 모니터링

### 시스템 상태

```bash
# CLI
python3 app/utils/cli.py status

# API
curl http://localhost:8000/api/status
```

### 로그 확인

#### Docker
```bash
sudo docker compose logs -f
```

#### 직접 실행
```bash
tail -f logs/app_$(date +%Y%m%d).log
```

### 큐 상태 확인

웹 UI → "큐 현황" 메뉴

---

## 🛑 시스템 중지

### Docker
```bash
sudo docker compose down
```

### 직접 실행
```bash
pkill -f "python3 main.py"
```

---

## 💡 팁

### 1. 빠른 테스트
```bash
# 모둠12에 테스트 방송
curl -X POST "http://localhost:8000/api/broadcast/text" \
  --data-urlencode "text=테스트" \
  --data-urlencode "target_rooms=315" \
  --data-urlencode "language=ko" \
  --data-urlencode "auto_off=true"
```

### 2. 일괄 제어
```python
# 여러 교실 동시 제어
import requests

# 1학년 전체 + 2학년 1반
requests.post('http://localhost:8000/api/device/matrix/set-active-rooms',
    json={'room_numbers': [101, 102, 103, 104, 201]})
```

### 3. 장치 상태 조회
```bash
curl http://localhost:8000/api/device-matrix/
```

---

## 📚 관련 문서

- [README.md](README.md) - 프로젝트 개요
- [DOCKER_GUIDE.md](DOCKER_GUIDE.md) - Docker 상세 가이드
- [INSTALLATION_COMPLETE.md](INSTALLATION_COMPLETE.md) - 설치 가이드
- API 문서: http://라즈베리파이IP:8000/docs

---

**즐거운 방송 되세요! 🎙️**

